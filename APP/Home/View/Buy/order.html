<extend name="Home@Layout/Shop" />

<block name="title">订单确认</block>

<block name="content">

    <h1>结账</h1>
    <div class="panel-group" id="accordion">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle collapsed" data-parent="#accordion" data-toggle="collapse" href="#collapse-shipping-address" aria-expanded="false">
                        第 1 步 货运地址 <i class="fa fa-caret-down"></i>
                    </a>
                </h4>
            </div>
            <!-- <div class="panel-collapse collapse" id="collapse-shipping-address">
            -->
            <div id="collapse-shipping-address" class="panel-collapse collapse in" aria-expanded="true" style="">
                <div class="panel-body">
                    
                        <div class="radio">
                            <label>
                                <input type="radio" value="existing" name="shipping_address">使用现存地址</label>
                        </div>
                        <div id="shipping-existing" style="display: block;">
                            <select class="form-control" id="select-address_id" name="address_id">
                            </select>
                        </div>
                        <div class="radio">
                            <label>
                                <input type="radio" value="new" name="shipping_address">添加一个新地址</label>
                        </div>
                        <br>
                        <form class="form-horizontal" id="form-address" method="post" action="">
                        <input type="hidden" name="operate" value="addAddress">
                        <div style="" id="shipping-new">
                            <div class="form-group required">
                                <label for="input-shipping-firstname" class="col-sm-2 control-label">您的姓名</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="input-shipping-firstname" placeholder="您的姓名" value="" name="name"></div>
                            </div>
                            <div data-sort="1" class="form-group required custom-field">
                                <label for="input-shipping-custom-field1" class="col-sm-2 control-label">手机号码</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="input-shipping-custom-field1" placeholder="手机号码" value="" name="telephone"></div>
                            </div>
                            <div class="form-group">
                                <label for="input-shipping-company" class="col-sm-2 control-label">公司名称</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="input-shipping-company" placeholder="公司名称" value="" name="company"></div>
                            </div>
                            <div class="form-group required">
                                <label for="input-shipping-country" class="col-sm-2 control-label">省/直辖市</label>
                                <div class="col-sm-2">
                                    <select class="form-control" id="select-region_level_1" data-level="1" name="country_id">
                                    </select>
                                </div>
                                <div class="col-sm-2">
                                    <select class="form-control" id="select-region_level_2" data-level="2" name="zone_id">
                                    <option value="-1">--- 请选择 ---</option>
                                    </select>
                                </div>

                                <div class="col-sm-2">
                                    <select class="form-control" id="select-region_level_3" data-level="3" name="city_id">
                                        <option value="-1">--- 请选择 ---</option>
                                    </select>
                                </div>
                                <div class="col-sm-4">
                                    <input type="text" class="form-control" id="input-shipping-address-1" placeholder="地址" value="" name="address"></div>
                            </div>
                            <div class="form-group">
                                <label for="input-shipping-postcode" class="col-sm-2 control-label">邮编</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="input-shipping-postcode" placeholder="邮编" value="" name="post_code"></div>
                            </div>
                        </div>
                        </form>

                        <div class="buttons clearfix">
                            <div class="pull-right">
                                <input type="button" class="btn btn-primary" data-loading-text="正在加载..." id="button-shipping-address" value="继续"></div>
                        </div>

                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle collapsed" data-parent="#accordion" data-toggle="collapse" href="#collapse-shipping-method" aria-expanded="false">
                        第 2 步 货运方式 <i class="fa fa-caret-down"></i>
                    </a>
                </h4>
            </div>
            <div id="collapse-shipping-method" class="panel-collapse collapse in" aria-expanded="true" style="">
                <div class="panel-body">
                    <p id="p-shipping-list">请选择一个货运方式。</p>

                    
                    <p>
                        <strong>添加订单备注</strong>
                    </p>
                    <p>
                        <textarea class="form-control" rows="8" name="comment"></textarea>
                    </p>
                    <div class="buttons">
                        <div class="pull-right">
                            <input type="button" class="btn btn-primary" data-loading-text="正在加载..." id="button-shipping-method" value="继续"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle collapsed" data-parent="#accordion" data-toggle="collapse" href="#collapse-payment-method" aria-expanded="false">
                        第 3 步 支付方式
                        <i class="fa fa-caret-down"></i>
                    </a>
                </h4>
            </div>
            <div id="collapse-payment-method" class="panel-collapse collapse in" aria-expanded="true" style="">
                <div class="panel-body">
                    <p id="p-payment-list">请选择一个支付方式。</p>

                    <p>
                        <strong>添加订单备注</strong>
                    </p>
                    <p>
                        <textarea class="form-control" rows="8" name="comment"></textarea>
                    </p>
                    <div class="buttons">
                        <div class="pull-right">
                            我已经阅读并同意
                            <a alt="条款及条件" href="http://php.kang.com/test/s/index.php?route=information/information/agree&amp;information_id=5" class="colorbox"> <b>条款及条件</b>
                            </a>
                            条款
                            <input type="checkbox" value="1" name="agree">
                            &nbsp;
                            <input type="button" class="btn btn-primary" data-loading-text="正在加载..." id="button-payment-method" value="继续"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a class="accordion-toggle" data-parent="#accordion" data-toggle="collapse" href="#collapse-checkout-confirm" aria-expanded="true">
                        第 4 步 确认订单
                        <i class="fa fa-caret-down"></i>
                    </a>
                </h4>
            </div>
            <div id="collapse-checkout-confirm" class="panel-collapse collapse in" aria-expanded="true" style="">
                <div class="panel-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="table-goods_list">
                            <thead>
                                <tr>
                                    <td class="text-left">商品名称</td>
                                    <td class="text-left">型号</td>
                                    <td class="text-right">数量</td>
                                    <td class="text-right">价格</td>
                                    <td class="text-right">合计</td>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                            <tfoot>
                                <tr>
                                    <td class="text-right" colspan="4">
                                        <strong>商品总额:</strong>
                                    </td>
                                    <td class="text-right">￥<span id="span-total_price"></span></td>
                                </tr>
                                <tr>
                                    <td class="text-right" colspan="4">
                                        <strong id="strong-shipping_title"></strong>
                                    </td>
                                    <td class="text-right">￥<span id="span-shipping_price"></span></td>
                                </tr>
                                <tr>
                                    <td class="text-right" colspan="4">
                                        <strong>订单总额:</strong>
                                    </td>
                                    <td class="text-right">￥<span id="span-order_total"></span></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="buttons">
                        <div class="pull-right">
                            <input type="button" data-loading-text="正在加载..." class="btn btn-primary" id="button-confirm" value="确认订单"></div>
                    </div>
                    <script type="text/javascript"></script>
                </div>
            </div>
        </div>
    </div>
</block>

<block name="appendJS">
<script>
    $(function() {
        getAddress();
    });

    function getAddress()
    {
        var url = '{:U('/ajax')}';
        var data = {
            'operate' : 'memberAddress',
        }
        $.get(url, data, function(response) {
            if (response.error == 0) {
                var rows = response.rows;// 货运地址的列表
                $('#select-address_id').empty();// 清空
                $.each(rows, function(i, row) {
                    // 拼凑option字符串, append到select中
                    var optionHtml = '<option value="' + row.address_id + '"';
                    // 保证默认的被选
                    if (row.is_default == '1') {
                        optionHtml += ' selected ';
                    }
                    optionHtml += '>' + row.name + ', ' + row.telephone + ', ' + row.country_title + ', ' + row.zone_title + ', ' + row.city_title + ', ' + row.address + ', ' + row.post_code + ', ' + row.company + '</option>';
                    $('#select-address_id').append(optionHtml);
                });

                // 使用现存地址选中
                $(':radio[name=shipping_address][value=existing]').prop('checked', true);
                // 将新地址表单隐藏
                $('#shipping-new').hide();
                
            } else {
                // 添加新地址被选
                $(':radio[name=shipping_address][value=new]').prop('checked', true);
                $('#shipping-new').show();
                console.log(response.errorInfo);
            }

        }, 'json');
    }
    </script>

    <script>
    $(':radio[name=shipping_address][value=new]').click(function() {
        // alert('show');
        $('#shipping-new').slideDown();
    });
    $(':radio[name=shipping_address][value=existing]').click(function() {
        $('#shipping-new').slideUp();
    });

    /**
     * [getRegion description]
     * @param  {[type]} region_id 常规的条件, 上级地区ID
     * @param  {Number} level     当前级别, 可以初始化省级地区, 和更新下级select
     * @return {[type]}           [description]
     */
    function getRegion(region_id, level=0)
    {
        // 初始化(1级)省级数据
        var url = '{:U('/ajax')}';
        var data = {
            'operate' : 'getRegion',
            'level' : level,
            'region_id': region_id
        }
        $.get(url, data, function(response) {
            if (response.error == 0) {
                // 更新级别为1的地区select
                var nextLevel = level + 1;
                $('#select-region_level_' + nextLevel).empty();
                // $('#select-region_level_' + nextLevel).append('<option value="-1">---- 请选择 ---</option>');
                if (level == 1) {
                    $('#select-region_level_3').empty();//.append('<option value="-1">--- 请选择 ---</option>');
                }
                $.each(response.rows, function(i, row) {
                    // 拼凑成option字符串
                    var optionHtml = '<option value="' + row.region_id + '">' + row.title + '</option>';
                    $('#select-region_level_' + nextLevel).append(optionHtml);
                });
            } else {
                console.log(response.errorInfo);
            }

        }, 'json');
    }

    // 初始第一级
    $(function(){
        getRegion(0, 0)
    });
    // change事件切换
    $('select[id^=select-region_level_][level!=3]').change(function(evt){
        // 获取当前选择的ID
        var currRegionID = $(this).val();
        // 利用该ID获取下级地区列表
        // 将下级的select展示
        getRegion(currRegionID, $(this).data('level'))

    });

    // 提交表单
    $('#button-shipping-address').click(function(evt) {
        var url = '{:U('/ajax')}';
        var data = $('#form-address').serialize();
        $.post(url, data, function(response){
            if (response.error == 0) {
                // 添加成功, 在配送地址列表, 展示配送地址, 同时清空添加表单
                // 封装的, 初始会员地址列表函数(向上找)
                getAddress();
                // 重置表单
                $('#form-address')[0].reset();
            } else {
                console.log(response.errorInfo);
            }
        }, 'json');

        // // 获取到表单的数据, 使用FormData(form的DOM对象)
        // // [0] jQuery对应的第一个DOM对象
        // var dataForm = new FormData($('#form-address')[0]);
        // // 在表单数据中, 添加ajax操作
        // dataForm.append('operate', 'addAddress');
        // // ajax添加
        // // 如果需要发送FormData类型的对象,则需要使用额外的配置, 需要$.ajax()
        // $.ajax({
        //     url: url,
        //     type: 'post',
        //     success: function(response) {
        //         if (response.error == 0) {
        //             // 添加成功, 在配送地址列表, 展示配送地址, 同时清空添加表单
        //             // 封装的, 初始会员地址列表函数(向上找)
        //             getAddress();
        //             // 重置表单
        //             $('#form-address')[0].reset();
        //         } else {
        //             console.log(response.errorInfo);
        //         }
        //     },
        //     dataType: 'json',
        //     data: dataForm,
        //     // 由于data数据为对象FromData对象, jQuery中, 默认会转换对象为字符串, 但是使用的是FormData, 不需要这个转换.
        //     // false, 表示禁止转换. (默认为true)
        //     processData: false,
        //     // 禁止$.ajax生成默认的请求数据类型头
        //     contentType: false,
        // });

        evt.preventDefault();// 停止这个默认的行为(可能是提交表单)
    });
    </script>

    <script>
    // 操作配送支付方式
    
    $(function() {
        // 获取配送方式
        var url = '{:U('/ajax')}';
        var data = {
            operate: 'getShipping',
        };
        $.get(url, data, function(response){
            if (response.error == 0) {
                var html = '';
                $.each(response.rows, function(i, row){
                    html += '<p>';
                    html += '<strong>' + row.title +'</strong>';
                    html += '</p><div class="radio"><label>';
                    html += '<input type="radio" value="'+row.shipping_id+'" name="shipping_method"';
                    if (row.is_default == '1') {
                        html += ' checked';
                    }
                    html += ' data-price="' + row.price + '"';
                    html += ' data-title="' + row.title + '"';
                    html += '>' + row.title + '- ￥' + row.price + '</label></div>';
                });
                // 外部追加到p元素后边
                $('#p-shipping-list').after(html);

                // 绑定事件
                 $('input[name=shipping_method]').click(function(){
                    $('#strong-shipping_title').html($(this).data('title'));
                    $('#span-shipping_price').html($(this).data('price'));
                    // 货运方式改变, 重新计算总金额
                    orderTotal();
                });

            } else {
                console.log(response.errorInfo);
            }
        }, 'json');

    });
    </script>

    <script>
    // 操作配送支付方式
    
    $(function() {

        // 获取支付方式
        var url = '{:U('/ajax')}';
        var data = {
            operate: 'getPayment',
        };
        $.get(url, data, function(response){
            if (response.error == 0) {
                var html = '';
                $.each(response.rows, function(i, row){
                    html += '<div class="radio"><label>';
                    html += '<input type="radio" value="'+row.payment_id+'" name="payment_method"';
                    if (row.is_default == '1') {
                        html += ' checked';
                    }
                    html += '>' + row.title  + '</label></div>';
                });
                // 外部追加到p元素后边
                $('#p-payment-list').after(html);

            } else {
                console.log(response.errorInfo);
            }
        }, 'json');

    });

    </script>


    <script>
    $(function(){
        var url = '{:U('/ajax')}';
        var data = {
            operate: 'getGoods',
        };
        $.get(url, data, function(response) {
            if (response.error == 0) {
                var rows = response.rows;
                var trHtml = '';
                $.each(rows, function(i, row) {
                    trHtml += '<tr> <td class="text-left"> <a href="' + row.goods_url + '">' + row.name + '</a> </td>';
                    trHtml += '<td class="text-left">';
                    $.each(row.option_list, function(ii, option) {
                        trHtml += option.ga_title + ': ' + option.ao_title + '<br>';
                    });
                    trHtml += '</td> <td class="text-right">' + row.buy_quantity + '</td>';
                    trHtml += '<td class="text-right">￥' + row.real_price + '</td>';
                    trHtml += '<td class="text-right">￥' + (row.real_price * row.buy_quantity) + '</td> </tr>';
                });

                $('#table-goods_list>tbody').empty().append(trHtml);

                var cartInfo = response.cartInfo;
                $('#span-total_price').html(cartInfo.total_price);
                // 计算总金额
                orderTotal();
            } else {
                console.log(response.errorInfo);
            }
        }, 'json');

    });
    </script>

    <script>
    function orderTotal()
    {
        var total = Number($('#span-total_price').text()) + Number($('#span-shipping_price').text());
        $('#span-order_total').text(total);
    }
    </script>

    <script>

    $('#button-confirm').click(function(evt){
        // 收集数据
        var orderForm = new FormData();
        // 将数据加入orderForm
        orderForm.append('address_id', $('#select-address_id').val());
        orderForm.append('shipping_method', $('input[name=shipping_method]:checked').val());
        orderForm.append('payment_method', $('input[name=payment_method]:checked').val());

        // ajax发出请求
        var url = '{:U('/checkout')}';
        $.ajax({
            type: 'post',
            url: url,
            data: orderForm,
            success: function(response) {
                if (response.error == 0) {
                    // 订单成功
                    console.log('订单成功');
                    // 页面跳转到下单结果页面
                    location.href=response.order_url;
                } else {
                    // 下单失败
                    console.log(response.errorInfo);
                }
            },
            dataType: 'json',
            processData: false,
            contentType: false,
        });
        
    });
    </script>
</block>